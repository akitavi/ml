name: ml
services:
  data-loader:
    image: akitavi/new_data_creator:0.1
    ports:
      - "8010:8010"
    command: ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8010", "--reload"]
    environment:
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
    volumes:
      - ./data_creator:/app:rw
    networks:
      - shared-net

  feach:
    image: akitavi/new_feach:0.1
    ports:
      - "8020:8010"

    working_dir: /app
    volumes:
      - ./feach:/app:rw

    command:
      - sh
      - -c
      - |
        mkdir -p /tmp/s3/raw /tmp/logs && \
        uvicorn app:app --host 0.0.0.0 --port 8010 --reload --reload-dir /app
    environment:
      # ---------- S3 / MinIO ----------
      MINIO_ENDPOINT: "http://minio:9000"
      MINIO_ACCESS_KEY: "minioadmin"
      MINIO_SECRET_KEY: "minioadmin"
      AWS_ACCESS_KEY_ID: "minioadmin"
      AWS_SECRET_ACCESS_KEY: "minioadmin"

      RAW_BUCKET: "raw-data"
      CLEAN_BUCKET: "clean-data"
      SHORTLIST_BUCKET: "clean-data"
      SHORTLIST_PREFIX: "shortlists"

      # ВАЖНО: writable + существующие директории
      S3_CSV_PATH: "/tmp/s3/raw"
      LOG_DIR: "/tmp/logs"

      # ---------- Kafka ----------
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      KAFKA_GROUP_ID: "ohlcv-group"
      RAW_TOPIC: "raw-data"
      CLEAN_TOPIC: "clean-data"
      CANDIDATES_TOPIC: "feature-candidates"
      KAFKA_MAX_RETRIES: "15"
      KAFKA_RETRY_INTERVAL: "3"

      # ---------- Feature generation ----------
      ENABLE_CANDIDATE_GEN: "true"

      TARGET_HORIZON: "1"
      WF_TRAIN_SIZE: "1500"
      WF_TEST_SIZE: "250"
      WF_STEP: "250"
      WF_MAX_SPLITS: "20"

      POOL_TOP_N: "120"
      SHORTLIST_MAX: "150"

      MAX_GROUP_SIZE: "8"
      BEAM_WIDTH: "50"

      PAIR_SCAN_TOP_N: "50"
      PAIR_SCAN_KEEP: "40"

      MAX_ABS_CORR_IN_GROUP: "0.95"
      DIVERSITY_JACCARD_MAX: "0.7"

      RANK_STD_PENALTY: "0.10"
      RANK_CORR_PENALTY: "0.20"

      # ---------- Logging ----------
      LOG_LEVEL: "INFO"
      LOG_TO_FILE: "false"
    networks:
      - shared-net

  worker:
    image: akitavi/new_worker:0.1
    environment:
      # Kafka
      KAFKA_BOOTSTRAP_SERVERS: "kafka:9092"
      KAFKA_GROUP_ID: "model-trainer-group"   # <-- одинаковый для всех реплик!
      INPUT_TOPIC: "feature-candidates"
      OUTPUT_TOPIC: "trained-models"
      DLQ_TOPIC: "feature-candidates-dlq"
      SEND_TO_DLQ_ON_ERROR: "true"
      AUTO_OFFSET_RESET: "earliest"
      POLL_TIMEOUT_MS: "2000"
      MAX_POLL_RECORDS: "1"

      # S3/MinIO (подставь свои значения)
      DATASET_BUCKET: "clean-data"
      MODELS_BUCKET: "models"

      # ваши переменные для s3_client.py (пример — адаптируй под свой config.py)
      S3_ENDPOINT_URL: "http://minio:9000"
      AWS_ACCESS_KEY_ID: "minioadmin"
      AWS_SECRET_ACCESS_KEY: "minioadmin"
      AWS_DEFAULT_REGION: "us-east-1"

      # FastAPI порт (внутри контейнера)
      PORT: "8010"

    expose:
      - "8010"

    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8010/health > /dev/null || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 10

    restart: unless-stopped


    working_dir: /app
    volumes:
      - ./worker:/app:rw

    command:
      - sh
      - -c
      - |
        mkdir -p /tmp/s3/raw /tmp/logs && \
        uvicorn app:app --host 0.0.0.0 --port 8010 --reload --reload-dir /app
    networks:
      - shared-net
  
networks:
  shared-net:
    external: true
    name: shared-net